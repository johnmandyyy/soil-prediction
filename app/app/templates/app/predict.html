{% extends "app/layout.html" %}
{% load static %}
{% block content %}

<div id="predict">
    <div class="row">

        <p class="lead fw-bold mb-0 pb-0">
            <i class="fa-solid fa-question"></i> Predict Image
        </p>
        <p class="font-weight-light text-muted">Here you can predict soil
            images.</p>
        <div class="col-lg-12">
            <div class="input-group">
                <input v-model="fileUpload" type="file" class="form-control"
                    id="fileInput"
                    aria-describedby="inputGroupFileAddon04"
                    aria-label="Upload">
                <button class="btn btn-primary" type="button"
                    @click="predictImage()"
                    id="inputGroupFileAddon04">Predict Image</button>
            </div>
        </div>

        <div class="col col-lg-12 mt-3">

            <p class="lead fw-bold mb-0 pb-0">
                <i class="fa-solid fa-square-poll-vertical"></i> Image Result
            </p>
            <p class="font-weight-light text-muted">This is the result of the
                image
                predicted.</p>

            <div class="text-right">

                <div class="text-center">

                    <div v-if="is_loading === true">
                        <h1 class="display-1">
                            <i class="fa-solid fa-spinner-third fa-spin"></i>
                        </h1>
                    </div>
                    <div v-else-if="is_loading === false && is_initial === false">
                        <img :src="'data:image/jpeg;base64,' + showImage"
                            class="rounded mb-3"
                            style="max-width: 224px; max-height: 224px;" alt="Image">
                    </div>

                    <p class="text fw-bold">Category: [[ category_list ]]</p>
                    <p class="text fw-bold">Probability Result: [[ probability ]]</p>

                </div>

            </div>

        </div>

    </div>
</div>

<script>

    new Vue({
        delimiters: ["[[", "]]"],
        el: "#predict",
    
        data: {
            "fileUpload": null,
            "showImage": null,
            "category_list": null,
            "probability": null,
            "is_loading": false,
            "is_initial": true
        },
        mounted() {
            if (document.querySelector("#predict")) {
                console.log("Mounted datasets page.")
                //this.getCategories()
            }
        },
        methods: {
            async predictImage() {
                this.is_loading = true
                const csrftoken = getCookie("csrftoken");
                axios.defaults.headers.common["X-CSRFToken"] = csrftoken;

                const form_data = new FormData();
                form_data.append('image', this.fileUpload)

                // Append the selected file to the FormData object
                const fileInput = document.getElementById('fileInput'); // Assuming you have an input element with id 'fileInput'
                const file = fileInput.files[0]; // Get the first file selected by the user
                form_data.append('image', file);

                
            await axios
                .post("/api/predict/", form_data)
                .then((response) => {
                    console.log(response)
                    this.showImage = response.data.base64_image
                    this.category_list = response.data.category_list
                    this.probability = response.data.probability
                    this.is_loading = false
                    this.is_initial = false
                })
                .catch((error) => {
                    console.error(error);
                    this.is_loading = false
                });
                
            }
        },
    });
    </script>

{% endblock %}
